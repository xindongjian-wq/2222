'use client';

import { useEffect, useState, useRef } from 'react';
import { useRouter, useParams } from 'next/navigation';

interface User {
  id: string;
  name?: string;
  email?: string;
  avatarUrl?: string;
}

interface Bot {
  id: string;
  name: string;
  coins: number;
}

interface ViewUser {
  id: string;
  name?: string;
  email?: string;
  avatarUrl?: string;
  tags?: string[];
  skills?: string[];
  hobbies?: string[];
  bio?: string;
}

// åœºæ™¯é¢„è®¾ç±»å‹
interface ScenePreset {
  id: string;
  name: string;
  emoji: string;
  category: 'sports' | 'social' | 'entertainment' | 'work' | 'nature' | 'hobby' | 'other';
  color: string;
  baseColor: string;
  description: string;
}

// ç”¨æˆ·åœºæ™¯ - æ¯å—åœ°é€‰æ‹©ä¸€ä¸ªåœºæ™¯
interface UserScene {
  id: string;
  userId: string;
  landIndex: number; // 0-5ï¼Œå¯¹åº”6å—åœ°
  scenePresetId: string;
  createdAt: string;
  updatedAt: string;
}

// ç­‰è½´æµ‹é…ç½®
const HEX_SIZE = 36;
const HEX_DEPTH = 14;
const HEX_GAP = 1;

// å›ºå®š6å—åœ°çš„èºæ—‹åæ ‡ï¼ˆå›´ç»•ä¸­å¿ƒæ’åˆ—ï¼‰
const LAND_POSITIONS: { q: number; r: number }[] = [
  { q: 0, r: 0 },     // ç¬¬1å— - ä¸­å¿ƒ
  { q: 1, r: 0 },     // ç¬¬2å— - å³
  { q: 0, r: 1 },     // ç¬¬3å— - å³ä¸‹
  { q: -1, r: 1 },    // ç¬¬4å— - å·¦ä¸‹
  { q: -1, r: 0 },    // ç¬¬5å— - å·¦
  { q: 0, r: -1 },    // ç¬¬6å— - å·¦ä¸Š
];

function axialToScreen(q: number, r: number): { x: number; y: number } {
  const x = HEX_SIZE * Math.sqrt(3) * (q + r / 2);
  const y = HEX_SIZE * 1.5 * r;
  return { x, y };
}

function drawHexTile(
  ctx: CanvasRenderingContext2D,
  q: number,
  r: number,
  color: string,
  sceneEmoji?: string,
  sceneColor?: string
) {
  const screen = axialToScreen(q, r);
  const size = HEX_SIZE - HEX_GAP;

  // å¦‚æœæœ‰åœºæ™¯ï¼Œä½¿ç”¨åœºæ™¯é¢œè‰²
  const tileColor = sceneColor || color;

  ctx.fillStyle = tileColor;
  ctx.beginPath();
  ctx.moveTo(screen.x + 3, screen.y + HEX_DEPTH + 3);
  for (let i = 0; i < 6; i++) {
    const angle = (2 * Math.PI / 6) * i;
    const px = screen.x + size * Math.cos(angle);
    const py = screen.y + size * Math.sin(angle);
    if (i === 0) ctx.lineTo(px + 3, py + HEX_DEPTH + 3);
    else ctx.lineTo(px + 3, py + HEX_DEPTH + 3);
  }
  ctx.closePath();
  ctx.fill();

  // å¦‚æœæœ‰åœºæ™¯emojiï¼Œç»˜åˆ¶åœ¨ä¸­å¿ƒ
  if (sceneEmoji) {
    ctx.fillStyle = '#fff';
    ctx.font = '20px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(sceneEmoji, screen.x + 3, screen.y + HEX_DEPTH + 3);
  }

  // ç»˜åˆ¶è¾¹æ¡†
  ctx.strokeStyle = 'rgba(255,255,255,0.3)';
  ctx.lineWidth = 1;
  ctx.stroke();
}

export default function MySpacePage() {
  const router = useRouter();
  const params = useParams<{ userId?: string }>();
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const [user, setUser] = useState<User | null>(null);
  const [bot, setBot] = useState<Bot | null>(null);
  const [viewUser, setViewUser] = useState<ViewUser | null>(null);  // æŸ¥çœ‹çš„å…¶ä»–ç”¨æˆ·
  const [userScenes, setUserScenes] = useState<UserScene[]>([]);
  const [scenePresets, setScenePresets] = useState<ScenePreset[]>([]);
  const [selectedLandIndex, setSelectedLandIndex] = useState<number | null>(null);
  const [scale, setScale] = useState(1);
  const [pan, setPan] = useState({ x: 0, y: 0 });

  // æ‰©å±•åœºæ™¯ç›¸å…³çŠ¶æ€
  const [extendedScenes, setExtendedScenes] = useState<any[]>([]);
  const [sceneMode, setSceneMode] = useState<'basic' | 'extended'>('basic');  // basic = åŸºç¡€60ç§, extended = æ‰©å±•300+ç§
  const [extendedCategory, setExtendedCategory] = useState<'all' | 'sports' | 'social' | 'entertainment' | 'work' | 'nature' | 'hobby' | 'space'>('all');
  const [extendedSearch, setExtendedSearch] = useState('');

  // åœºæ™¯é€‰æ‹©å¼¹çª—çŠ¶æ€
  const [showSceneModal, setShowSceneModal] = useState(false);

  // åˆ†ç±»
  const categories = [
    { value: 'sports', label: 'è¿åŠ¨', emoji: 'ğŸ€', color: 'bg-orange-100 text-orange-700' },
    { value: 'social', label: 'ç¤¾äº¤', emoji: 'â˜•', color: 'bg-amber-100 text-amber-700' },
    { value: 'entertainment', label: 'å¨±ä¹', emoji: 'ğŸ¬', color: 'bg-pink-100 text-pink-700' },
    { value: 'work', label: 'åŠå…¬', emoji: 'ğŸ¢', color: 'bg-blue-100 text-blue-700' },
    { value: 'nature', label: 'è‡ªç„¶', emoji: 'ğŸŒ³', color: 'bg-green-100 text-green-700' },
    { value: 'hobby', label: 'å…´è¶£', emoji: 'ğŸ¨', color: 'bg-purple-100 text-purple-700' },
  ];

  // åŠ è½½æ•°æ®
  useEffect(() => {
    loadData();
  }, [params.userId]);

  const loadData = async () => {
    try {
      const targetUserId = params.userId;  // URLå‚æ•°ä¸­çš„ç”¨æˆ·ID

      // å¦‚æœæœ‰userIdå‚æ•°ï¼Œå°è¯•åŠ è½½è¯¥ç”¨æˆ·çš„ä¿¡æ¯ï¼ˆæŸ¥çœ‹æ¨¡å¼ï¼‰
      if (targetUserId) {
        const viewUserRes = await fetch(`/api/user/view?userId=${targetUserId}`);
        if (viewUserRes.ok) {
          const viewUserData = await viewUserRes.json();
          if (viewUserData.code === 0) {
            setViewUser(viewUserData.data.user);
            // åŠ è½½è¯¥ç”¨æˆ·çš„Botå’Œåœºæ™¯
            setBot(viewUserData.data.bot);
            const userScenes = viewUserData.data.scenes || [];
            setUserScenes(userScenes);
          }
        }
      }

      // åŠ è½½åœºæ™¯é¢„è®¾ï¼ˆæ— è®ºæŸ¥çœ‹æ¨¡å¼è¿˜æ˜¯ç¼–è¾‘æ¨¡å¼éƒ½éœ€è¦ï¼‰
      const scenesRes = await fetch('/api/scenes');
      if (scenesRes.ok) {
        const scenesData = await scenesRes.json();
        setScenePresets(scenesData.data || []);
      }

      // åŠ è½½æ‰©å±•åœºæ™¯é¢„è®¾
      try {
        const extendedRes = await fetch('/api/scenes/extended');
        if (extendedRes.ok) {
          const extendedData = await extendedRes.json();
          setExtendedScenes(extendedData.data || []);
        }
      } catch (e) {
        console.error('Failed to load extended scenes:', e);
      }

      // å¦‚æœæ²¡æœ‰ç›®æ ‡userIdï¼ˆæŸ¥çœ‹è‡ªå·±çš„ç©ºé—´ï¼‰ï¼ŒåŠ è½½è‡ªå·±çš„æ•°æ®
      if (!targetUserId) {
        // åŠ è½½å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
        const userRes = await fetch('/api/user');
        let userId: string | null = null;
        if (userRes.ok) {
          const userData = await userRes.json();
          if (userData.code === 0) {
            setUser(userData.data.user);
            setBot(userData.data.bot);
            userId = userData.data.user?.id || null;
          }
        }

        // åŠ è½½ç”¨æˆ·çš„6å—åœ°åœºæ™¯
        if (userId) {
          const userScenesRes = await fetch(`/api/scenes/user/${userId}`);
          if (userScenesRes.ok) {
            const userScenesData = await userScenesRes.json();
            setUserScenes(userScenesData.data || []);
          }
        }
      }
    } catch (error) {
      console.error('Failed to load data:', error);
    }
  };

  // è®¾ç½®åœºæ™¯
  const handleSetScene = async (scenePresetId: string) => {
    if (selectedLandIndex === null) return;
    try {
      const res = await fetch('/api/scenes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          landIndex: selectedLandIndex,
          scenePresetId,
        }),
      });

      if (res.ok) {
        const data = await res.json();
        if (data.code === 0) {
          setUserScenes(prev => {
            const updated = [...prev];
            updated[selectedLandIndex] = data.data;
            return updated;
          });
          setShowSceneModal(false);
          setSelectedLandIndex(null);
        }
      }
    } catch (error) {
      console.error('Failed to set scene:', error);
    }
  };

  // Canvas æ¸²æŸ“
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // è®¾ç½®canvaså¤§å°
    canvas.width = 1400;
    canvas.height = 900;

    const render = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(700 + pan.x, 450 + pan.y);
      ctx.scale(scale, scale);

      // ç»˜åˆ¶èƒŒæ™¯
      ctx.fillStyle = '#f8fafc';
      ctx.fillRect(-700, -500, 1400, 1000);

      // ç»˜åˆ¶6å—åœ°
      LAND_POSITIONS.forEach((pos, index) => {
        const userScene = userScenes[index];
        // åŒæ—¶æŸ¥æ‰¾åŸºç¡€åœºæ™¯å’Œæ‰©å±•åœºæ™¯
        const scenePreset = userScene
          ? [...scenePresets, ...extendedScenes].find(s => s.id === userScene.scenePresetId)
          : null;

        const isMine = Boolean(user || viewUser);
        const isSelected = selectedLandIndex === index;

        drawHexTile(ctx, pos.q, pos.r, scenePreset?.baseColor || '#d1d5db', scenePreset?.emoji, scenePreset?.color);

        // ç»˜åˆ¶è¾¹æ¡†
        ctx.strokeStyle = isSelected ? '#fbbf24' : (isMine ? '#8b5cf6' : 'rgba(255,255,255,0.3)');
        ctx.lineWidth = isSelected ? 3 : (isMine ? 2 : 1);
        ctx.stroke();

        // å¦‚æœæ˜¯ç”¨æˆ·çš„åœ°å—ï¼Œæ˜¾ç¤ºç¼–å·
        if (isMine) {
          ctx.fillStyle = '#374151';
          ctx.font = 'bold 14px sans-serif';
          ctx.textAlign = 'center';
          const screen = axialToScreen(pos.q, pos.r);
          ctx.fillText(`${index + 1}`, screen.x + 3, screen.y - 10);
        }
      });

      ctx.restore();
    };

    render();
  }, [userScenes, scenePresets, extendedScenes, selectedLandIndex, scale, pan, user, viewUser]);

  // å¤„ç†ç‚¹å‡»é€‰æ‹©åœ°å—
  const handleCanvasClick = (e: React.MouseEvent<HTMLCanvasElement>) => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const rawX = (e.clientX - rect.left) * scaleX - canvas.width / 2 - pan.x;
    const rawY = (e.clientY - rect.top) * scaleY - canvas.height / 2 - pan.y;
    const clickX = rawX / scale;
    const clickY = rawY / scale;

    LAND_POSITIONS.forEach((pos, index) => {
      const screen = axialToScreen(pos.q, pos.r);
      if (Math.sqrt((clickX - screen.x) ** 2 + (clickY - screen.y) ** 2) < HEX_SIZE * 0.8) {
        if (canEdit) {
          setSelectedLandIndex(index);
          // æ˜¾ç¤ºåœºæ™¯é€‰æ‹©å¼¹çª—
          setShowSceneModal(true);
        } else {
          // è§‚çœ‹æ¨¡å¼ï¼šæ˜¾ç¤ºæç¤º
          const userScene = userScenes[index];
          // åŒæ—¶æŸ¥æ‰¾åŸºç¡€åœºæ™¯å’Œæ‰©å±•åœºæ™¯
          const scenePreset = userScene
            ? [...scenePresets, ...extendedScenes].find(s => s.id === userScene.scenePresetId)
            : null;
          const sceneName = scenePreset ? scenePreset.name : 'æœªè®¾ç½®åœºæ™¯';
          alert(`åœ°å— ${index + 1}: ${sceneName}\n${scenePreset ? scenePreset.description : ''}`);
        }
        return;
      }
    });

    setSelectedLandIndex(null);
  };

  // æ»šè½®ç¼©æ”¾
  const handleWheel = (e: React.WheelEvent<HTMLCanvasElement>) => {
    e.preventDefault();
    setScale(prev => Math.max(0.4, Math.min(2.5, prev + (e.deltaY > 0 ? -0.1 : 0.1))));
  };

  // æ‹–æ‹½å¹³ç§»
  const [isDragging, setIsDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

  const handleMouseDown = (e: React.MouseEvent<HTMLCanvasElement>) => {
    if (e.button === 0) {
      setIsDragging(true);
      setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
    }
  };

  const handleMouseMove = (e: React.MouseEvent<HTMLCanvasElement>) => {
    if (isDragging) setPan({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
  };

  const handleMouseUp = () => setIsDragging(false);

  // å¦‚æœæ­£åœ¨åŠ è½½æ•°æ®ä¸”æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
  const isLoading = !user && !viewUser;

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100">
        <div className="text-center">
          <p className="text-gray-600 mb-4">åŠ è½½ä¸­...</p>
        </div>
      </div>
    );
  }

  // æ˜¯å¦å¯ä»¥ç¼–è¾‘ï¼ˆåªæœ‰æŸ¥çœ‹è‡ªå·±çš„ç©ºé—´æ—¶å¯ä»¥ç¼–è¾‘ï¼‰
  const canEdit = !viewUser && Boolean(user);

  return (
    <div className="min-h-screen bg-gray-50">
      {/* é¡¶éƒ¨å¯¼èˆª */}
      <header className="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div className="flex items-center justify-between px-4 py-3">
          <div className="flex items-center gap-4">
            <button onClick={() => router.push('/arena')} className="flex items-center gap-2 text-gray-600 hover:text-gray-900">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
              <span className="font-medium">åœ°è„‰</span>
            </button>
            <h1 className="text-xl font-bold text-gray-800">
              {viewUser ? `æŸ¥çœ‹ ${viewUser.name || 'ç”¨æˆ·'} çš„ç©ºé—´` : 'æˆ‘çš„ç©ºé—´'}
            </h1>
          </div>
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-amber-400 to-orange-500 rounded-full">
              <span className="text-2xl">ğŸ’°</span>
              <span className="text-white font-bold text-lg">{bot?.coins || 0}</span>
            </div>
            {viewUser ? (
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white text-xs font-bold">
                  {(viewUser.name || 'U')[0]}
                </div>
                <span className="text-sm text-gray-700 font-medium">{viewUser?.name || viewUser?.email || 'ç”¨æˆ·'}</span>
              </div>
            ) : user ? (
              <div className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full">
                <div className="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white text-xs font-bold">
                  {(user?.name || 'U')[0]}
                </div>
                <span className="text-sm text-gray-700 font-medium">{user?.name || user?.email || 'ç”¨æˆ·'}</span>
              </div>
            ) : null}
          </div>
        </div>
      </header>

      <main className="flex h-[calc(100vh-64px)]">
        {/* å·¦ä¾§ - ç­‰è½´æµ‹åœ°å›¾ */}
        <div className="flex-1 flex justify-center items-center bg-gradient-to-br from-slate-100 to-slate-200 relative overflow-hidden">
          <canvas
            ref={canvasRef}
            width={1400}
            height={900}
            onClick={handleCanvasClick}
            onWheel={handleWheel}
            onMouseDown={handleMouseDown}
            onMouseMove={handleMouseMove}
            onMouseUp={handleMouseUp}
            className="w-full h-full cursor-pointer"
          />

          {/* åœ°å›¾æ§åˆ¶ */}
          <div className="absolute bottom-4 left-4 bg-white/90 backdrop-blur rounded-lg px-4 py-3 shadow-sm">
            <div className="flex items-center gap-4">
              <button onClick={() => setScale(prev => Math.min(2.5, prev + 0.15))} className="w-10 h-10 text-gray-600 hover:bg-gray-100">+</button>
              <div className="px-3 text-gray-600 text-sm">{Math.round(scale * 100)}%</div>
              <button onClick={() => setScale(prev => Math.max(0.4, prev - 0.15))} className="w-10 h-10 text-gray-600 hover:bg-gray-100">-</button>
              <button onClick={() => { setScale(1); setPan({ x: 0, y: 0 }); }} className="w-10 h-10 text-gray-600 hover:bg-gray-100">âŸ²</button>
            </div>
            <p className="text-xs text-gray-500 mt-2">
              {canEdit ? 'ç‚¹å‡»åœ°å—ç®¡ç†åœºæ™¯ | æ»šè½®ç¼©æ”¾ | æ‹–æ‹½å¹³ç§»' : 'ç‚¹å‡»åœ°å—æŸ¥çœ‹è¯¦æƒ… | æ»šè½®ç¼©æ”¾ | æ‹–æ‹½å¹³ç§»'}
            </p>
          </div>
        </div>
      </main>

      {/* åœºæ™¯é€‰æ‹©å¼¹çª— */}
      {showSceneModal && selectedLandIndex !== null && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" onClick={() => setShowSceneModal(false)}>
          <div className="bg-white rounded-2xl p-6 w-[500px] max-h-[80vh] overflow-y-auto">
            <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span>ğŸ¨</span>
              <span>ä¸ºåœ°å— {selectedLandIndex + 1} é€‰æ‹©åœºæ™¯</span>
            </h2>

            {/* åœºæ™¯ç±»å‹é€‰æ‹© */}
            <div className="flex gap-2 mb-4 bg-gray-50 p-2 rounded-lg">
              <button
                onClick={() => setSceneMode('basic')}
                className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all ${
                  sceneMode === 'basic' ? 'bg-purple-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'
                }`}
              >
                åŸºç¡€åœºæ™¯ (60ç§)
              </button>
              <button
                onClick={() => setSceneMode('extended')}
                className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all ${
                  sceneMode === 'extended' ? 'bg-purple-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'
                }`}
              >
                æ‰©å±•åœºæ™¯ (300+ç§)
              </button>
            </div>

            {/* åˆ†ç±»é€‰æ‹© - åŸºç¡€åœºæ™¯ */}
            {sceneMode === 'basic' && (
              <>
                {/* åˆ†ç±»é€‰æ‹© */}
                <div className="space-y-4">
                  {categories.map(cat => (
                    <div key={cat.value}>
                      <h3 className="font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <span>{cat.emoji}</span>
                        <span>{cat.label}ç±»åœºæ™¯</span>
                      </h3>
                      <div className="grid grid-cols-4 gap-2">
                        {scenePresets
                          .filter(s => s.category === cat.value)
                          .map(scene => (
                            <button
                              key={scene.id}
                              onClick={() => handleSetScene(scene.id)}
                              className={`p-3 rounded-lg border-2 transition-all ${
                                userScenes[selectedLandIndex]?.scenePresetId === scene.id
                                  ? 'border-green-500 bg-green-50 ring-2 ring-green-500'
                                  : 'border-gray-200 hover:border-purple-300 hover:bg-purple-50'
                              }`}
                            >
                              <span className="text-2xl block">{scene.emoji}</span>
                              <span className="text-sm font-medium">{scene.name}</span>
                              <span className="text-xs text-gray-500">{scene.description}</span>
                            </button>
                          ))}
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}

            {/* åˆ†ç±»é€‰æ‹© - æ‰©å±•åœºæ™¯ */}
            {sceneMode === 'extended' && (
              <div className="mb-4">
                <input
                  type="text"
                  placeholder="æœç´¢åœºæ™¯..."
                  className="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4"
                  onChange={(e) => setExtendedSearch(e.target.value)}
                  value={extendedSearch}
                />
                <div className="space-y-4">
                  {/* å¿«é€Ÿåˆ†ç±» */}
                  <div className="flex flex-wrap gap-2 mb-4">
                    <button
                      onClick={() => setExtendedCategory('all')}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                        extendedCategory === 'all' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      å…¨éƒ¨
                    </button>
                    <button
                      onClick={() => setExtendedCategory('sports')}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                        extendedCategory === 'sports' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      è¿åŠ¨
                    </button>
                    <button
                      onClick={() => setExtendedCategory('social')}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                        extendedCategory === 'social' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ç¤¾äº¤
                    </button>
                    <button
                      onClick={() => setExtendedCategory('entertainment')}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                        extendedCategory === 'entertainment' ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      å¨±ä¹
                    </button>
                    <button
                      onClick={() => setExtendedCategory('work')}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                        extendedCategory === 'work' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      åŠå…¬
                    </button>
                    <button
                      onClick={() => setExtendedCategory('nature')}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                        extendedCategory === 'nature' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      è‡ªç„¶
                    </button>
                    <button
                      onClick={() => setExtendedCategory('hobby')}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                        extendedCategory === 'hobby' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      å…´è¶£
                    </button>
                    <button
                      onClick={() => setExtendedCategory('space')}
                      className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                        extendedCategory === 'space' ? 'bg-indigo-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      å¤ªç©º
                    </button>
                  </div>
                </div>

                {/* æ‰©å±•åœºæ™¯åˆ—è¡¨ */}
                <div className="max-h-[50vh] overflow-y-auto space-y-2 pr-2">
                  {extendedScenes
                    .filter(scene => {
                      if (extendedCategory === 'all') return true;
                      return scene.category === extendedCategory;
                    })
                    .slice(0, 50)
                    .map(scene => (
                      <button
                        key={scene.id}
                        onClick={() => handleSetScene(scene.id)}
                        className={`w-full p-3 rounded-lg border-2 transition-all text-left flex items-center gap-3 ${
                          userScenes[selectedLandIndex]?.scenePresetId === scene.id
                            ? 'border-green-500 bg-green-50'
                            : 'border-gray-200 hover:border-purple-300 hover:bg-purple-50'
                        }`}
                      >
                        <span className="text-2xl">{scene.emoji}</span>
                        <div className="flex-1">
                          <span className="font-medium text-sm">{scene.name}</span>
                          <span className="text-xs text-gray-500">{scene.description}</span>
                        </div>
                      </button>
                    ))}
                </div>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
